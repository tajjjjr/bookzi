<!DOCTYPE html>
<html>
<head>
    <title>Bookzi Admin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a87; }
        .product { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .product img { max-width: 100px; height: auto; }
        .auth-section { background: #f5f5f5; padding: 20px; margin-bottom: 20px; border-radius: 4px; }
        .hidden { display: none; }
        .cart { background: #e8f4f8; padding: 15px; margin: 20px 0; border-radius: 4px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #ddd; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #f0f0f0; border: 1px solid #ddd; cursor: pointer; }
        .tab.active { background: #007cba; color: white; }
        .order-form { background: #f9f9f9; padding: 20px; border-radius: 4px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bookzi Product Management</h1>
        
        <!-- Auth Section -->
        <div class="auth-section">
            <div id="login-form">
                <h3>Login</h3>
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-password" placeholder="Password">
                <button onclick="login()">Login</button>
                <button onclick="showRegister()">Register</button>
            </div>
            
            <div id="register-form" class="hidden">
                <h3>Register</h3>
                <input type="text" id="register-name" placeholder="Name">
                <input type="email" id="register-email" placeholder="Email">
                <input type="password" id="register-password" placeholder="Password">
                <button onclick="register()">Register</button>
                <button onclick="showLogin()">Back to Login</button>
            </div>
            
            <div id="user-info" class="hidden">
                <span id="user-name"></span>
                <button onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Product Management -->
        <div id="product-management" class="hidden">
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('products')">Products</div>
                <div class="tab" onclick="showTab('shop')">Shop</div>
                <div class="tab" onclick="showTab('orders')">Orders</div>
            </div>

            <!-- Products Tab -->
            <div id="products-tab">
                <!-- Create Product Form -->
                <div class="form-group">
                    <h3>Create Product</h3>
                <form id="product-form" enctype="multipart/form-data">
                    <label>Name:</label>
                    <input type="text" id="product-name" required>
                    
                    <label>Description:</label>
                    <textarea id="product-description"></textarea>
                    
                    <label>Price (cents):</label>
                    <input type="number" id="product-price" required>
                    
                    <label>SKU:</label>
                    <input type="text" id="product-sku" required>
                    
                    <label>Stock:</label>
                    <input type="number" id="product-stock" required>
                    
                    <label>Images:</label>
                    <input type="file" id="product-images" multiple accept="image/*">
                    
                    <button type="button" onclick="createProduct()">Create Product</button>
                    <button type="button" onclick="resetForm()" style="display:none;" id="cancel-btn">Cancel</button>
                </form>
            </div>

                <!-- Products List -->
                <div>
                    <h3>Products</h3>
                    <button onclick="loadProducts()">Refresh</button>
                    <div id="products-list"></div>
                </div>
            </div>

            <!-- Shop Tab -->
            <div id="shop-tab" class="hidden">
                <h3>Shop Products</h3>
                <div class="cart">
                    <h4>Shopping Cart (<span id="cart-count">0</span> items)</h4>
                    <div id="cart-items"></div>
                    <div><strong>Total: $<span id="cart-total">0.00</span></strong></div>
                    <button onclick="showCheckout()" id="checkout-btn" disabled>Checkout</button>
                </div>
                <button onclick="loadShopProducts()">Load Products</button>
                <div id="shop-products"></div>
            </div>

            <!-- Orders Tab -->
            <div id="orders-tab" class="hidden">
                <h3>My Orders</h3>
                <button onclick="loadOrders()">Refresh</button>
                <div id="orders-list"></div>
            </div>

            <!-- Checkout Modal -->
            <div id="checkout-modal" class="hidden">
                <div class="order-form">
                    <h3>Checkout</h3>
                    <label>Email:</label>
                    <input type="email" id="customer-email" required>
                    <label>Phone:</label>
                    <input type="tel" id="customer-phone">
                    <label>Notes:</label>
                    <textarea id="order-notes" placeholder="Special instructions..."></textarea>
                    <button onclick="createOrder()">Place Order</button>
                    <button onclick="hideCheckout()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');

        // Decode JWT to get user info
        function decodeJWT(token) {
            try {
                const payload = token.split('.')[1];
                return JSON.parse(atob(payload));
            } catch (e) {
                return null;
            }
        }

        // Check if already logged in
        if (authToken) {
            currentUser = decodeJWT(authToken);
            showProductManagement();
            updateCartDisplay();
        }

        function showLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function showProductManagement() {
            document.querySelector('.auth-section').classList.add('hidden');
            document.getElementById('product-management').classList.remove('hidden');
            loadProducts();
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    currentUser = decodeJWT(authToken);
                    localStorage.setItem('authToken', authToken);
                    console.log('Logged in user:', currentUser);
                    showProductManagement();
                } else {
                    alert('Login failed: ' + data.error);
                }
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        }

        async function register() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('Registration successful! Please login.');
                    showLogin();
                } else {
                    alert('Registration failed: ' + data.error);
                }
            } catch (error) {
                alert('Registration error: ' + error.message);
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            location.reload();
        }

        async function createProduct() {
            const formData = new FormData();
            
            const productData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseInt(document.getElementById('product-price').value),
                currency: 'USD',
                sku: document.getElementById('product-sku').value,
                stock: parseInt(document.getElementById('product-stock').value),
                trackInventory: true,
                allowBackorder: false,
                hasVariants: false,
                slug: document.getElementById('product-name').value.toLowerCase().replace(/\s+/g, '-'),
                isActive: true
            };
            
            formData.append('product', JSON.stringify(productData));
            
            const files = document.getElementById('product-images').files;
            for (let i = 0; i < files.length; i++) {
                formData.append('images', files[i]);
            }
            
            try {
                const response = await fetch('/api/products/create-with-images', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('Product created successfully!');
                    document.getElementById('product-form').reset();
                    loadProducts();
                } else {
                    alert('Product creation failed: ' + data.error);
                }
            } catch (error) {
                alert('Product creation error: ' + error.message);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                const data = await response.json();
                if (response.ok) {
                    displayProducts(data.data || data);
                } else {
                    alert('Failed to load products: ' + data.error);
                }
            } catch (error) {
                alert('Load products error: ' + error.message);
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('products-list');
            container.innerHTML = '';
            
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';
                productDiv.innerHTML = `
                    <h4>${product.name}</h4>
                    <p><strong>SKU:</strong> ${product.sku}</p>
                    <p><strong>Price:</strong> $${(product.price / 100).toFixed(2)}</p>
                    <p><strong>Stock:</strong> ${product.stock}</p>
                    <p>${product.description || ''}</p>
                    ${product.images && product.images.length > 0 ? 
                        product.images.map(img => `<img src="${img.url}" alt="${img.alt}">`).join('') : 
                        '<p>No images</p>'
                    }
                    <br>
                    <button onclick="editProduct('${product.id}')">Edit</button>
                    <button onclick="deleteProduct('${product.id}')">Delete</button>
                `;
                container.appendChild(productDiv);
            });
        }

        function editProduct(productId) {
            fetch('/api/products/' + productId, {
                headers: { 'Authorization': 'Bearer ' + authToken }
            })
            .then(response => response.json())
            .then(product => {
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-sku').value = product.sku;
                document.getElementById('product-stock').value = product.stock;
                
                const form = document.getElementById('product-form');
                form.dataset.editId = productId;
                document.querySelector('button[onclick="createProduct()"]').textContent = 'Update Product';
                document.querySelector('button[onclick="createProduct()"]').setAttribute('onclick', 'updateProduct()');
                document.getElementById('cancel-btn').style.display = 'inline-block';
            })
            .catch(error => alert('Error loading product: ' + error.message));
        }

        async function updateProduct() {
            const productId = document.getElementById('product-form').dataset.editId;
            
            const productData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseInt(document.getElementById('product-price').value),
                sku: document.getElementById('product-sku').value,
                stock: parseInt(document.getElementById('product-stock').value)
            };
            
            try {
                const response = await fetch('/api/products/' + productId, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken 
                    },
                    body: JSON.stringify(productData)
                });
                
                if (response.ok) {
                    alert('Product updated successfully!');
                    resetForm();
                    loadProducts();
                } else {
                    const data = await response.json();
                    alert('Update failed: ' + data.error);
                }
            } catch (error) {
                alert('Update error: ' + error.message);
            }
        }

        function resetForm() {
            document.getElementById('product-form').reset();
            delete document.getElementById('product-form').dataset.editId;
            const btn = document.querySelector('button[onclick="updateProduct()"]') || document.querySelector('button[onclick="createProduct()"]');
            btn.textContent = 'Create Product';
            btn.setAttribute('onclick', 'createProduct()');
            document.getElementById('cancel-btn').style.display = 'none';
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            try {
                const response = await fetch('/api/products/' + productId, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (response.ok) {
                    alert('Product deleted successfully!');
                    loadProducts();
                } else {
                    const data = await response.json();
                    alert('Delete failed: ' + data.error);
                }
            } catch (error) {
                alert('Delete error: ' + error.message);
            }
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('[id$="-tab"]').forEach(tab => tab.classList.add('hidden'));
            
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            if (tabName === 'shop') {
                loadShopProducts();
                updateCartDisplay();
            }
            if (tabName === 'orders') loadOrders();
        }

        // Cart Management
        function addToCart(productId, name, price, sku) {
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    productId,
                    productName: name,
                    sku,
                    price,
                    quantity: 1,
                    subtotal: price,
                    tax: 0,
                    total: price,
                    isFulfilled: false,
                    isRefunded: false
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartCount = document.getElementById('cart-count');
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            if (!cartCount) return; // Elements not loaded yet
            
            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            cartItems.innerHTML = '';
            let total = 0;
            
            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <span>${item.productName} x${item.quantity}</span>
                    <span>$${((item.price * item.quantity) / 100).toFixed(2)}</span>
                    <button onclick="removeFromCart('${item.productId}')">Remove</button>
                `;
                cartItems.appendChild(itemDiv);
                total += item.price * item.quantity;
            });
            
            cartTotal.textContent = (total / 100).toFixed(2);
            if (checkoutBtn) {
                checkoutBtn.disabled = cart.length === 0;
            }
        }

        async function loadShopProducts() {
            try {
                const response = await fetch('/api/products', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                const data = await response.json();
                if (response.ok) {
                    displayShopProducts(data.data || data);
                }
            } catch (error) {
                alert('Error loading products: ' + error.message);
            }
        }

        function displayShopProducts(products) {
            const container = document.getElementById('shop-products');
            container.innerHTML = '';
            
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';
                productDiv.innerHTML = `
                    <h4>${product.name}</h4>
                    <p><strong>Price:</strong> $${(product.price / 100).toFixed(2)}</p>
                    <p><strong>Stock:</strong> ${product.stock}</p>
                    <p>${product.description || ''}</p>
                    <button onclick="addToCart('${product.id}', '${product.name}', ${product.price}, '${product.sku}')" 
                            ${product.stock <= 0 ? 'disabled' : ''}>
                        ${product.stock <= 0 ? 'Out of Stock' : 'Add to Cart'}
                    </button>
                `;
                container.appendChild(productDiv);
            });
        }

        function showCheckout() {
            console.log('Checkout button clicked');
            const modal = document.getElementById('checkout-modal');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('Checkout modal shown');
            } else {
                console.error('Checkout modal not found');
            }
        }

        function hideCheckout() {
            document.getElementById('checkout-modal').classList.add('hidden');
        }

        async function createOrder() {
            const email = document.getElementById('customer-email').value;
            const phone = document.getElementById('customer-phone').value;
            const notes = document.getElementById('order-notes').value;
            
            if (!email) {
                alert('Email is required');
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = Math.round(subtotal * 0.08); // 8% tax
            const total = subtotal + tax;
            
            const userId = currentUser?.sub || currentUser?.id || 'user-' + Date.now();
            const orderData = {
                userId: userId,
                items: cart,
                subtotal,
                tax,
                shippingCost: 0,
                total,
                currency: 'USD',
                customerEmail: email,
                customerPhone: phone,
                notes
            };
            
            console.log('Creating order with userId:', userId, 'from user:', currentUser);
            
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    alert('Order placed successfully!');
                    cart = [];
                    localStorage.removeItem('cart');
                    updateCartDisplay();
                    hideCheckout();
                    setTimeout(() => {
                        showTab('orders');
                    }, 100);
                } else {
                    const data = await response.json();
                    alert('Order failed: ' + data.error);
                }
            } catch (error) {
                alert('Order error: ' + error.message);
            }
        }

        async function loadOrders() {
            try {
                console.log('Loading orders for user:', currentUser);
                const response = await fetch('/api/orders', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                const data = await response.json();
                console.log('Orders response:', data);
                if (response.ok) {
                    // Handle paginated response
                    const orders = data.data || data;
                    console.log('Orders to display:', orders);
                    displayOrders(orders);
                } else {
                    console.error('Orders API error:', data);
                }
            } catch (error) {
                console.error('Orders fetch error:', error);
                alert('Error loading orders: ' + error.message);
            }
        }

        function displayOrders(orders) {
            console.log('displayOrders called with:', orders);
            const container = document.getElementById('orders-list');
            if (!container) {
                console.error('orders-list container not found');
                return;
            }
            
            container.innerHTML = '';
            
            if (!orders || orders.length === 0) {
                console.log('No orders to display');
                container.innerHTML = '<p>No orders found.</p>';
                return;
            }
            
            console.log('Displaying', orders.length, 'orders');
            orders.forEach((order, index) => {
                console.log('Processing order', index, order);
                const orderDiv = document.createElement('div');
                orderDiv.className = 'product';
                orderDiv.innerHTML = `
                    <h4>Order ${order.orderNumber || order.id}</h4>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Total:</strong> $${(order.total / 100).toFixed(2)}</p>
                    <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleDateString()}</p>
                    <p><strong>Items:</strong> ${order.items ? order.items.length : 0}</p>
                `;
                container.appendChild(orderDiv);
            });
        }
    </script>
</body>
</html>